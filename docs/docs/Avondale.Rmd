---
title: "Avondale Housing"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r library, include=FALSE}
library(sf)
library(tidyverse)
library(tidycensus)
library(tigris)
library(leaflet)
library(leaflet.extras)
library(mapview)

census_api_key("e13d5be5cb48d927009e0dca0af99d21918d514f", overwrite = TRUE)

options(scipen = 999)

```

```{r theme, include = FALSE}
theme_cc <- function(){
  font = "sans"
  theme_minimal() %+replace%
    theme(
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.ticks = element_blank(),
      axis.ticks.x.bottom = element_line(
        color = "grey90", 
        size = .5),
      plot.title = element_text(
        family = font,
        size = 14,
        face = 'bold',
        hjust = 0,
        vjust = 0),
      plot.subtitle = element_text(
        family = font,
        size = 12,
        hjust = 0,
        margin = margin(2, b = 10),
        face = "italic"),
      plot.caption = element_text(
        family = font,
        size = 10,
        hjust = 1),
      axis.title = element_text(
        family = font,
        size = 10,
        margin = margin(5, b = 10)),
      axis.text = element_blank(),
      legend.position = "right",
      legend.text = element_text(
        family = font,
        size = 8)
      )
}
```

```{r avondaledata, include=FALSE}
name <- "Avondale"

codes <- c("R-10", # R - Single Family/Cabin
           "R-20", # R - Two Family
           "R-30", # R - Multi Family/Dorms/Single
           "R-40", # A - Apartments (4-19 Units)
           "R-50", # R - Condominium
           "R-55", # R - Town House (Common Law Condo)
           "R-60", # R - Dwelling W/Comm Use Primary R
           "R-61", # C - Dwelling W/Comm Use Primary C
           "R-90") # A - Apt Complex (20 or more units


mobile <- c("R-70", # R - Mobile Home
            "T-10", # R - Trailers and Mobile Homes
            "C-92") # C - Mobile Home Parks (4+)


dat <- read_csv("data/chesco_characteristics_avondale_10.2023.csv") %>%
  dplyr::filter(LUC %in% codes) %>%
  dplyr::filter(WATER == 1) %>%
  select(PARID, LUC_desc, YRBLT, COMM_YRBLT, X_CO, Y_CO, situs, SUBDNUM, SUBDIV)

dat2 <- read_csv("data/chesco_characteristics_avondale_10.2023.csv") %>%
  dplyr::filter(LUC %in% mobile) %>%
  dplyr::filter(WATER == 1) %>%
  select(PARID, LUC_desc, X_CO, Y_CO, situs) %>%
  na.omit()

points <- st_as_sf(dat, coords = c("X_CO", "Y_CO"), crs = "EPSG:2272") %>%
  st_transform(crs="EPSG:4326") 

points2 <- st_as_sf(dat2, coords = c("X_CO", "Y_CO"), crs = "EPSG:2272") %>%
  st_transform(crs="EPSG:4326")

points <- points %>% 
  mutate(year = dplyr::coalesce(YRBLT, COMM_YRBLT)) %>%
  mutate(if1991 = 
           case_when(year < 1991 ~ "Before 1991",
                     year >= 1991 ~ "1991 or Later"
                     ),
         yearGroup = 
           case_when(year > 2010 ~ "2011-2022",
                     year >= 2001 & year < 2011 ~ "2001-2010",
                     year >= 1991 & year < 2001 ~ "1991-2000",
                     year >= 1981 & year < 1991 ~ "1981-1990",
                     year >= 1971 & year < 1981 ~ "1971-1980",
                     year >= 1961 & year < 1971 ~ "1961-1970",
                     year >= 1951 & year < 1961 ~ "1951-1960",
                     year < 1951 ~ "1950 or older"
                     )
         ) %>%
  select(-YRBLT, COMM_YRBLT)

chester <- counties(state = 42) %>%
  dplyr::filter(NAME == "Chester")%>%
  st_transform(crs="EPSG:4326") 

municipalities <- county_subdivisions(42, county = "Chester") %>%
  st_transform(crs="EPSG:4326") 

town <- municipalities %>%
  dplyr::filter(NAME == name) %>%
  st_transform(crs="EPSG:4326") 

# Create a palette that maps factor levels to colors
pal1 <- colorFactor(c("#0057e5", 
                      "#e50000"), 
                   domain = c("1991 or Later", 
                              "Before 1991")
                   )

pal2 <- colorFactor(c("#003b5c", 
                      "#0057e5",
                      "#41b6e6",
                      "#3ea908",
                      "#f0cc2e",
                      "#ec894d",
                      "#e50000",
                      "#e641b6"),
                    domain = c("1950 or older",
                               "1951-1960",
                               "1961-1970",
                               "1971-1980",
                               "1981-1990",
                               "1991-2000",
                               "2001-2010",
                               "2011-2022"))

pal3 <- colorFactor("viridis", domain = NULL)

```

```{r}

bbox <- st_bbox(town)
bbox_sf <- st_as_sfc(bbox)

background<- municipalities %>%
  st_intersection(.,bbox_sf)

cc_roads <- roads(state = "PA", county = "Chester")%>%
  st_transform(crs="EPSG:4326") %>%
  st_intersection(.,bbox_sf)

cc_water <- area_water(state = "PA", county = "Chester")%>%
  st_transform(crs="EPSG:4326") %>%
  st_intersection(.,bbox_sf)

Avondale_1991 <- ggplot()+
  geom_sf(data = background, color = "grey80", fill = "white")+
  geom_sf(data= cc_water, fill = "royalblue1", color = "royalblue1")+
  geom_sf(data = cc_roads, color = "grey60", lwd = .8) +
  geom_sf(data = town, color = "grey20", fill = "NA", lwd = 1)+
  geom_sf(data = points, aes(color = if1991), alpha = .6, size = 3)+
  labs(color = "Year Built")+
  theme_cc()
Avondale_1991

ggsave("images/Avondale_1991.png", plot = Avondale_1991, dpi=300)

Avondale_years <- ggplot()+
  geom_sf(data = background, color = "grey80", fill = "white")+
  geom_sf(data= cc_water, fill = "royalblue1", color = "royalblue1")+
  geom_sf(data = cc_roads, color = "grey60", lwd = .8) +
  geom_sf(data = town, color = "grey20", fill = "NA", lwd = 1)+
  geom_sf(data = points, aes(color = yearGroup), alpha = .6, size = 3)+
  scale_color_viridis_d(option = "H")+
  labs(color = "Year Built")+
  theme_cc()
Avondale_years
ggsave("images/Avondale_years.png", plot = Avondale_years, dpi=300)

```

```{r avondalemap}

m <- leaflet(width = "100%") %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  setView(lng = town$INTPTLON, 
          lat = town$INTPTLAT,
          zoom = 15) %>%
  addPolygons(data = town,
              weight = 2,
              opacity = .5,
              color = "black",
              fillOpacity = .01) %>%
  addLayersControl(baseGroups = c("Pre- or Post-1991", "Year Category", "Subdivision", "Mobile or Trailer Homes"),
                   options = layersControlOptions(collapsed = FALSE,),
                   position = "topright"
                   ) %>%
  addCircleMarkers(data = points,
                   radius = 4,
                   weight = 2,
                   opacity = .8,
                   stroke = TRUE,
                   color = ~pal1(if1991),
                   popup = ~paste("Address:", situs,
                                  "<br>Year Built:", year,
                                  "<br>Zoning:", LUC_desc,
                                  "<br>Subdivision:", SUBDIV
                                  ),
                   group = "Pre- or Post-1991"
                   ) %>%
  addLegend(pal = pal1, 
            data = points,
            values = ~if1991,
            group = "Pre- or Post-1991",
            position = "topright",
            title = "Year Built",
            layerId = "Pre- or Post-1991"
            ) %>%
  addCircleMarkers(data = points,
                   radius = 4,
                   weight = 2,
                   opacity = .8,
                   stroke = TRUE,
                   color = ~pal2(yearGroup),
                   popup = ~paste("Address:", situs,
                                  "<br>Year Built:", year,
                                  "<br>Zoning:", LUC_desc,
                                  "<br>Subdivision:", SUBDIV
                                  ),
                   group = "Year Category"
                   ) %>%
  addLegend(pal = pal2, 
            data = points, 
            values = ~yearGroup, 
            group = "Year Category", 
            position = "topright",
            title = "Year Built",
            layerId = "Year Category"
            ) %>%
  addCircleMarkers(data = points,
                   radius = 4,
                   weight = 2,
                   opacity = .8,
                   stroke = TRUE,
                   color = ~pal3(SUBDIV),
                   popup = ~paste("Address:", situs,
                                  "<br>Year Built:", year,
                                  "<br>Zoning:", LUC_desc,
                                  "<br>Subdivision:", SUBDIV
                                  ),
                   group = "Subdivision"
                   ) %>%
  addLegend(pal = pal3, 
            data = points, 
            values = ~SUBDIV, 
            group = "Subdivision", 
            position = "topright",
            title = "Subdivision",
            layerId = "Subdivision"
            ) %>% 
  addCircleMarkers(data = points2,
                   radius = 4,
                   weight = 2,
                   opacity = .8,
                   stroke = TRUE,
                   popup = ~paste("Address:", situs,
                                  "<br>Zoning:", LUC_desc
                                  ),
                   group = "Mobile or Trailer Homes"
                   ) %>%
  leaflet.extras::addResetMapButton() %>%
  htmlwidgets::onRender("
    function(el, x) {
      var initialLegend = 'Pre- or Post-1991' // Set the initial legend to be displayed by layerId
      var myMap = this;
      for (var legend in myMap.controls._controlsById) {
        var el = myMap.controls.get(legend.toString())._container;
        if(legend.toString() === initialLegend) {
          el.style.display = 'block';
        } else {
          el.style.display = 'none';
        };
      };
    myMap.on('baselayerchange',
      function (layer) {
        for (var legend in myMap.controls._controlsById) {
          var el = myMap.controls.get(legend.toString())._container;
          if(legend.toString() === layer.name) {
            el.style.display = 'block';
          } else {
            el.style.display = 'none';
          };
        };
      });
    }") #https://gist.github.com/noamross/98c2053d81085517e686407096ec0a69

m

```

